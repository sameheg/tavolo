name: Codex Bootstrap
on:
  push:
    branches: [ main ]
    paths: [ 'ops/labels.json', 'ops/sprints.json' ]
  workflow_dispatch: {}
permissions:
  contents: write
  issues: write
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Sync Labels & Sprints
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const labels = JSON.parse(fs.readFileSync(`${process.env.GITHUB_WORKSPACE}/ops/labels.json`, 'utf8'));
            for (const l of labels) {
              try {
                await github.rest.issues.updateLabel({owner: context.repo.owner, repo: context.repo.repo, name: l.name, color: l.color, description: l.description});
              } catch {
                await github.rest.issues.createLabel({owner: context.repo.owner, repo: context.repo.repo, name: l.name, color: l.color, description: l.description});
              }
            }
            const sprints = JSON.parse(fs.readFileSync(`${process.env.GITHUB_WORKSPACE}/ops/sprints.json`, 'utf8'));
            for (const s of sprints) {
              try {
                await github.rest.issues.createMilestone({owner: context.repo.owner, repo: context.repo.repo, title: s.title, due_on: s.due_on, description: s.description});
              } catch(e) {
                console.log('Milestone create skipped', s.title, e.message);
              }
            }
